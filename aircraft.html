<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Flugzeuge â€¢ Ground Handling Log</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="container" style="padding-bottom:72px">
    <h2>âœˆï¸ Flugzeuge</h2>
    <div class="card"><p class="small">Tippe auf eine Registrierung fÃ¼r Details.</p></div>
    <ul class="list" id="aircraftList"></ul>
  </div>

  <nav>
    <button data-go="dashboard.html">ğŸ“Š</button>
    <button class="active" data-go="aircraft.html">âœˆï¸</button>
    <button data-go="album.html">ğŸ´</button>
    <button data-go="social.html">ğŸ‘¥</button>
  </nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCC9zB_me4qdyBmHZ0TeUDPB1WoPNa6e1A",
  authDomain: "ground-handling-log.firebaseapp.com",
  projectId: "ground-handling-log",
  appId: "1:771821879817:web:35ad14da4ab4613b832ed8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const list = document.getElementById("aircraftList");

onAuthStateChanged(auth, async (user) => {
  if (!user) { location.href = "index.html"; return; }

  const qy = query(
    collection(db, "flights"),
    where("userId", "==", user.uid),
    orderBy("timestamp", "desc")
  );
  const snap = await getDocs(qy);

  const map = new Map();
  snap.forEach(d => {
    const f = d.data();
    const key = f.registration;
    if (!map.has(key)) {
      map.set(key, { registration:key, aircraftType:f.aircraftType, airline:f.airline, count:0, special:false, livery:"" });
    }
    const a = map.get(key);
    a.count++;
    if (f.special) { a.special = true; a.livery = f.livery || a.livery; }
  });

  list.innerHTML = "";
  [...map.values()].sort((a,b)=>b.count-a.count).forEach(a => {
    const li = document.createElement("li");
    li.innerHTML = `
      <span><strong>${a.registration}</strong> â€¢ ${a.aircraftType} â€¢ ${a.airline}</span>
      <span>${a.count}Ã— ${a.special ? "ğŸ¨" : ""}</span>
    `;
    li.addEventListener("click", () => {
      location.href = `aircraft-detail.html?reg=${encodeURIComponent(a.registration)}`;
    });
    list.appendChild(li);
  });

  if (!list.children.length) {
    list.innerHTML = `<li><span class="small">Noch keine FlÃ¼ge eingetragen.</span><span></span></li>`;
  }
});
</script>

<script>
document.querySelectorAll('nav button').forEach(b=>b.addEventListener('click',()=>location.href=b.dataset.go));
</script>
</body>
</html>
