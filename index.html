<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ground Handling Log – Login</title>
  <link rel="stylesheet" href="style.css">
</head>

<body class="center">

<div style="width:min(420px,100%)">
  <h1>✈️ Ground Handling Log</h1>
  <p class="small">Login für Bodenabfertiger</p>

  <div class="card">
    <button onclick="loginGoogle()">Mit Google anmelden</button>

    <hr>

    <input id="email" placeholder="E-Mail">
    <input id="password" type="password" placeholder="Passwort">

    <button onclick="loginEmail()">Login</button>
    <button onclick="registerEmail()" class="btn-secondary">Registrieren</button>

    <p id="status" class="small"></p>
  </div>
</div>

<!-- Firebase SDKs (COMPAT – stabil für iOS Safari) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ==========================
   FIREBASE INITIALISIERUNG
========================== */
const firebaseConfig = {
  apiKey: "AIzaSyCC9zB_me4qdyBmHZ0TeUDPB1WoPNa6e1A",
  authDomain: "ground-handling-log.firebaseapp.com",
  projectId: "ground-handling-log",
  appId: "1:771821879817:web:35ad14da4ab4613b832ed8"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const statusEl = document.getElementById("status");

/* ==========================
   HELFER
========================== */
async function ensureUser(user) {
  try {
    const ref = db.collection("users").doc(user.uid);
    const snap = await ref.get();

    if (!snap.exists) {
      await ref.set({
        uid: user.uid,
        name: user.displayName || "Handler",
        email: user.email || "",
        createdAt: Date.now(),
        stats: {
          totalFlights: 0,
          totalDelay: 0,
          avgDelay: 0,
          totalPax: 0,
          totalCargo: 0,
          avgScore: 0
        }
      });
    }
  } catch (e) {
    console.log("ensureUser:", e);
  }
}

function goDashboard() {
  window.location.replace("dashboard.html");
}

/* ==========================
   GOOGLE LOGIN (REDIRECT)
========================== */
window.loginGoogle = async function () {
  try {
    statusEl.textContent = "Weiterleitung zu Google…";
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithRedirect(provider);
  } catch (e) {
    statusEl.textContent = "Google Fehler: " + e.message;
  }
};

/* ==========================
   EMAIL LOGIN
========================== */
window.loginEmail = async function () {
  try {
    statusEl.textContent = "Login…";
    await auth.signInWithEmailAndPassword(
      document.getElementById("email").value.trim(),
      document.getElementById("password").value
    );
  } catch (e) {
    statusEl.textContent = "Login Fehler: " + e.message;
  }
};

/* ==========================
   EMAIL REGISTRIERUNG
========================== */
window.registerEmail = async function () {
  try {
    statusEl.textContent = "Registrierung…";
    await auth.createUserWithEmailAndPassword(
      document.getElementById("email").value.trim(),
      document.getElementById("password").value
    );
  } catch (e) {
    statusEl.textContent = "Registrierung Fehler: " + e.message;
  }
};

/* ==========================
   REDIRECT + SESSION
========================== */
auth.getRedirectResult().then(async (result) => {
  if (result && result.user) {
    statusEl.textContent = "✅ Eingeloggt…";
    await ensureUser(result.user);
    goDashboard();
  }
});

auth.onAuthStateChanged(async (user) => {
  if (user) {
    await ensureUser(user);
    goDashboard();
  }
});
</script>

</body>
</html>
