<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ground Handling Log – Login</title>
  <link rel="stylesheet" href="style.css">
</head>

<body class="center">
<div style="width:min(420px,100%)">
  <h1>✈️ Ground Handling Log</h1>
  <p class="small">Login</p>

  <div class="card">
    <button id="googleBtn">Mit Google anmelden</button>

    <hr>

    <input id="email" placeholder="E-Mail">
    <input id="password" type="password" placeholder="Passwort">

    <button id="emailLogin">Login</button>
    <button id="emailRegister" class="btn-secondary">Registrieren</button>

    <p id="status" class="small"></p>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCC9zB_me4qdyBmHZOTeUDP8IWoPNa6e1A",
  authDomain: "ground-handling-log.firebaseapp.com",
  projectId: "ground-handling-log",
  storageBucket: "ground-handling-log.firebasestorage.app",
  messagingSenderId: "771821879817",
  appId: "1:771821879817:web:35ad14da4ab4613b832ed8",
  measurementId: "G-SS17MF912N"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const statusEl = document.getElementById("status");

async function ensureUser(user) {
  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();
  if (!snap.exists) {
    await ref.set({
      uid: user.uid,
      name: user.displayName || "Handler",
      email: user.email || "",
      createdAt: Date.now(),
      stats: { totalFlights:0, totalDelay:0, avgDelay:0, totalPax:0, totalCargo:0, avgScore:0 }
    });
  }
}

function goDashboard(){
  // replace verhindert zurück-loop über back-button
  window.location.replace("dashboard.html");
}

// ✅ WICHTIG: Session auf iPhone speichern
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.log);

// Google Login: iPhone sicher via Redirect
document.getElementById("googleBtn").onclick = async () => {
  statusEl.textContent = "Weiterleitung zu Google…";
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithRedirect(provider);
  } catch(e) {
    statusEl.textContent = "Google Fehler: " + e.message;
  }
};

// Email login/register
document.getElementById("emailLogin").onclick = async () => {
  try {
    statusEl.textContent = "Login…";
    await auth.signInWithEmailAndPassword(
      document.getElementById("email").value.trim(),
      document.getElementById("password").value
    );
  } catch(e) {
    statusEl.textContent = "Login Fehler: " + e.message;
  }
};

document.getElementById("emailRegister").onclick = async () => {
  try {
    statusEl.textContent = "Registrierung…";
    await auth.createUserWithEmailAndPassword(
      document.getElementById("email").value.trim(),
      document.getElementById("password").value
    );
  } catch(e) {
    statusEl.textContent = "Registrierung Fehler: " + e.message;
  }
};

// Redirect Result
auth.getRedirectResult().then(async (res) => {
  if (res && res.user) {
    statusEl.textContent = "✅ Eingeloggt…";
    await ensureUser(res.user);
    goDashboard();
  }
}).catch(e => {
  // nicht hart failen
  console.log("getRedirectResult:", e);
});

// Session Watcher: nur EINMAL weiterleiten, wenn User wirklich da ist
auth.onAuthStateChanged(async (user) => {
  if (user) {
    statusEl.textContent = "✅ Session gefunden…";
    await ensureUser(user);
    goDashboard();
  }
});
</script>
</body>
</html>
