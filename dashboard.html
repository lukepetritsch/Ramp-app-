<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ground Handling Log â€“ Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    :root{
      --bg:#0b1220;
      --card1:rgba(255,255,255,0.08);
      --card2:rgba(255,255,255,0.04);
      --stroke:rgba(255,255,255,0.10);
      --text:#ffffff;
      --muted:rgba(255,255,255,0.75);
      --blue:#1f6feb;
      --green:#4ade80;
      --yellow:#facc15;
      --red:#f87171;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      background: radial-gradient(1000px 500px at 50% -100px, rgba(31,111,235,0.22), transparent 60%),
                  linear-gradient(180deg, #0b1220, #070b14);
      color:var(--text);
    }
    header{
      position:sticky;
      top:0;
      z-index:10;
      padding:16px 14px 10px 14px;
      background:rgba(11,18,32,0.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .topRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:0.2px;
    }
    .pillRow{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      background:rgba(255,255,255,0.07);
      border:1px solid rgba(255,255,255,0.08);
      color:rgba(255,255,255,0.9);
    }
    .btn{
      border:none;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      color:#fff;
      background:var(--blue);
    }
    .btn.secondary{ background:rgba(255,255,255,0.10); }
    main{
      padding:14px 14px 92px 14px;
      max-width:1040px;
      margin:0 auto;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
    }
    @media (min-width: 760px){
      .grid{ grid-template-columns:repeat(4,minmax(0,1fr)); }
    }
    .card{
      border-radius:16px;
      padding:14px;
      background:linear-gradient(145deg,var(--card1),var(--card2));
      border:1px solid rgba(255,255,255,0.08);
      min-height:86px;
    }
    .kpi{
      font-size:22px;
      font-weight:900;
      margin:0;
    }
    .label{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }
    .section{ margin-top:18px; }
    .sectionTitle{
      font-size:14px;
      font-weight:900;
      margin:0 0 10px 2px;
      color:rgba(255,255,255,0.92);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .subhint{
      font-size:12px;
      color:rgba(255,255,255,0.65);
      font-weight:600;
    }
    .list{
      list-style:none;
      margin:0;
      padding:0;
      display:grid;
      gap:10px;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.06);
    }
    .row .left{ min-width:0; }
    .row strong{
      display:block;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .row span{
      display:block;
      font-size:12px;
      color:rgba(255,255,255,0.72);
      margin-top:3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge{
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.06);
      white-space:nowrap;
    }
    .good{ color:var(--green); }
    .ok{ color:var(--yellow); }
    .bad{ color:var(--red); }

    .bars{
      display:grid;
      gap:10px;
    }
    .barRow{
      display:grid;
      grid-template-columns: 132px 1fr 52px;
      gap:10px;
      align-items:center;
      font-size:12px;
      color:rgba(255,255,255,0.85);
    }
    .bar{
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
    }
    .bar > div{
      height:100%;
      width:0%;
      background:rgba(31,111,235,0.9);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    nav{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:rgba(11,18,32,0.92);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,0.08);
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:8px;
      padding:10px;
    }
    nav a{
      text-decoration:none;
      color:#fff;
      text-align:center;
      padding:10px 8px;
      border-radius:12px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.06);
      font-weight:900;
      font-size:12px;
    }
    nav a.active{
      background:rgba(31,111,235,0.28);
      border-color:rgba(31,111,235,0.45);
    }
    .empty{
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,0.05);
      border:1px dashed rgba(255,255,255,0.14);
      color:rgba(255,255,255,0.75);
      font-size:13px;
      line-height:1.35;
    }
  </style>
</head>
<body>

<header>
  <div class="topRow">
    <h1>ğŸ“Š Ground Handling Dashboard</h1>
    <button id="logoutBtn" class="btn secondary">Logout</button>
  </div>
  <div class="pillRow">
    <span class="pill">ğŸ‘¤ <span id="userName">â€”</span></span>
    <span class="pill">ğŸ“§ <span id="userEmail">â€”</span></span>
    <span class="pill">ğŸ†” <span id="userUid" class="mono">â€”</span></span>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card"><p class="kpi" id="kpiFlights">0</p><div class="label">âœˆï¸ Abfertigungen</div></div>
    <div class="card"><p class="kpi" id="kpiDelay">0</p><div class="label">â± Gesamt-Delay (Min)</div></div>
    <div class="card"><p class="kpi" id="kpiPax">0</p><div class="label">ğŸ‘¥ Passagiere gesamt</div></div>
    <div class="card"><p class="kpi" id="kpiCargo">0</p><div class="label">ğŸ“¦ Cargo gesamt (kg)</div></div>
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card"><p class="kpi" id="kpiAvgDelay">0,0</p><div class="label">âš¡ Ã˜ Delay (Min)</div></div>
    <div class="card"><p class="kpi" id="kpiScore">0,0â­</p><div class="label">â­ Ã˜ Handling Score</div></div>
    <div class="card"><p class="kpi" id="kpiOnTime">0%</p><div class="label">âœ… PÃ¼nktlich (â‰¤ 0)</div></div>
    <div class="card"><p class="kpi" id="kpiCards">0</p><div class="label">ğŸ´ Karten gesammelt (Typ+Airline)</div></div>
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card"><p class="kpi" id="kpiAirlines">0</p><div class="label">ğŸ¢ Airlines gesammelt</div></div>
    <div class="card"><p class="kpi" id="kpiTypes">0</p><div class="label">ğŸ›© Flugzeugtypen</div></div>
    <div class="card"><p class="kpi" id="kpiRegs">0</p><div class="label">ğŸ†” Registrierungen</div></div>
    <div class="card"><p class="kpi" id="kpiLiveries">0</p><div class="label">ğŸ¨ Sonderlackierungen</div></div>
  </div>

  <div class="section">
    <div class="sectionTitle">
      <span>ğŸ§¾ Letzte Abfertigungen</span>
      <span class="subhint" id="lastUpdated">â€”</span>
    </div>
    <ul class="list" id="recentList"></ul>
    <div id="recentEmpty" class="empty" style="display:none;">
      Noch keine Abfertigungen gespeichert.<br/>
      Gehe auf <b>âœï¸ Eintragen</b> und speichere deinen ersten Flug (inkl. Delay, IATA Code, Pax & Cargo).
    </div>
  </div>

  <div class="section">
    <div class="sectionTitle">
      <span>ğŸ§¾ Top IATA Delay Codes</span>
      <span class="subhint">nach HÃ¤ufigkeit</span>
    </div>
    <ul class="list" id="topCodes"></ul>
    <div id="codesEmpty" class="empty" style="display:none;">
      Keine Delay Codes vorhanden (entweder Delay = 0 oder kein Code ausgewÃ¤hlt).
    </div>
  </div>

  <div class="section">
    <div class="sectionTitle">
      <span>ğŸ“Œ Delay Ursachen (Cluster)</span>
      <span class="subhint">Anteil der Delays</span>
    </div>
    <div class="card">
      <div class="bars" id="clusterBars"></div>
      <div class="subhint" style="margin-top:10px; line-height:1.35;">
        Cluster: Passenger (10â€“19), Cargo/Ramp (20â€“29), Handling (30â€“39), Technical (40â€“49), Weather/ATC (50â€“59), Security/Ops (60â€“69), Crew/Airline (70â€“79), External/Misc (80â€“99)
      </div>
    </div>
  </div>

  <div class="section">
    <div class="sectionTitle">
      <span>ğŸ´ Sammelalbum â€“ letzte Karten</span>
      <span class="subhint">neu freigeschaltet</span>
    </div>
    <ul class="list" id="newCards"></ul>
    <div id="cardsEmpty" class="empty" style="display:none;">
      Noch keine Karten. Karten werden automatisch gesammelt, sobald du eine Abfertigung speicherst (Flugzeugtyp + Airline).
    </div>
  </div>
</main>

<nav>
  <a class="active" href="dashboard.html">ğŸ“Š Dashboard</a>
  <a href="app.html">âœï¸ Eintragen</a>
  <a href="aircraft.html">âœˆï¸ Flugzeuge</a>
  <a href="album.html">ğŸ´ Album</a>
  <a href="social.html">ğŸ‘¥ Social</a>
</nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    limit,
    getDocs,
    doc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // âœ… WICHTIG: Ersetze diesen Block 1:1 mit deinem echten firebaseConfig (genau wie in index.html)
  const firebaseConfig = {
    apiKey: "HIER_API_KEY_EINTRAGEN",
    authDomain: "HIER_AUTH_DOMAIN",
    projectId: "HIER_PROJECT_ID",
    appId: "HIER_APP_ID"
  };

  const fmtInt = (n) => (n ?? 0).toLocaleString("de-DE");
  const fmt1 = (n) => (isFinite(n) ? n.toFixed(1).replace(".", ",") : "0,0");

  function scoreFromDelay(d){
    if (d <= -5) return 5;
    if (d <= 0) return 4;
    if (d <= 5) return 3;
    if (d <= 15) return 2;
    return 1;
  }
  function delayClass(d){
    if (d <= 0) return "good";
    if (d <= 10) return "ok";
    return "bad";
  }
  function clusterFromCode(codeStr){
    const c = Number(codeStr);
    if (!isFinite(c)) return "Unknown";
    if (c <= 9) return "Reserved (00â€“09)";
    if (c <= 19) return "Passenger (10â€“19)";
    if (c <= 29) return "Cargo/Ramp (20â€“29)";
    if (c <= 39) return "Handling (30â€“39)";
    if (c <= 49) return "Technical (40â€“49)";
    if (c <= 59) return "Weather/ATC (50â€“59)";
    if (c <= 69) return "Security/Ops (60â€“69)";
    if (c <= 79) return "Crew/Airline (70â€“79)";
    if (c <= 89) return "External (80â€“89)";
    return "Misc (90â€“99)";
  }

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const el = (id) => document.getElementById(id);

  el("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "index.html";
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }

    el("userEmail").textContent = user.email || "â€”";
    el("userName").textContent = user.displayName || "Handler";
    el("userUid").textContent = user.uid.slice(0, 10) + "â€¦";

    await setDoc(doc(db, "users", user.uid), {
      uid: user.uid,
      email: user.email || null,
      name: user.displayName || "Handler",
      updatedAt: serverTimestamp()
    }, { merge: true });

    await loadDashboard(user.uid);
  });

  async function loadDashboard(uid){
    const flightsRef = collection(db, "users", uid, "flights");
    const q = query(flightsRef, orderBy("ts", "desc"), limit(50));

    let flights = [];
    try{
      const snap = await getDocs(q);
      flights = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }catch(err){
      el("recentEmpty").style.display = "block";
      el("recentEmpty").innerHTML = "Firestore konnte nicht gelesen werden.<br/>Aktiviere <b>Firestore Database</b> in Firebase (Build â†’ Firestore Database) und setze Rules. Fehler:<br/><span class='mono'>"+(err?.message||err)+"</span>";
      el("codesEmpty").style.display = "block";
      el("cardsEmpty").style.display = "block";
      updateKpis([]);
      renderClusters([]);
      return;
    }

    el("lastUpdated").textContent = "geladen: " + new Date().toLocaleTimeString("de-DE", {hour:"2-digit", minute:"2-digit"});

    renderRecent(flights.slice(0, 12));
    updateKpis(flights);
    renderTopCodes(flights);
    renderClusters(flights);
    renderNewCards(flights);
  }

  function updateKpis(flights){
    const totalFlights = flights.length;
    const totalDelay = flights.reduce((s,f)=>s + Number(f.delay||0),0);
    const totalPax = flights.reduce((s,f)=>s + Number(f.pax||0),0);
    const totalCargo = flights.reduce((s,f)=>s + Number(f.cargo||0),0);
    const avgDelay = totalFlights ? (totalDelay / totalFlights) : 0;
    const avgScore = totalFlights ? (flights.reduce((s,f)=>s+scoreFromDelay(Number(f.delay||0)),0) / totalFlights) : 0;
    const onTime = totalFlights ? (flights.filter(f=>Number(f.delay||0) <= 0).length / totalFlights) * 100 : 0;

    const cards = new Set(flights.map(f => (f.aircraft||"â€”") + " | " + (f.airline||"â€”")));
    const airlines = new Set(flights.map(f => f.airline||"â€”"));
    const types = new Set(flights.map(f => f.aircraft||"â€”"));
    const regs = new Set(flights.map(f => f.registration||"â€”"));

    const liveries = new Set(
      flights
        .filter(f => f.special === true || f.special === "true")
        .map(f => (f.livery && String(f.livery).trim()) ? String(f.livery).trim() : (f.registration ? "Special: "+f.registration : "Special"))
    );

    el("kpiFlights").textContent = fmtInt(totalFlights);
    el("kpiDelay").textContent = fmtInt(totalDelay);
    el("kpiPax").textContent = fmtInt(totalPax);
    el("kpiCargo").textContent = fmtInt(totalCargo);
    el("kpiAvgDelay").textContent = fmt1(avgDelay);
    el("kpiScore").textContent = fmt1(avgScore) + "â­";
    el("kpiOnTime").textContent = fmt1(onTime).replace(",0","") + "%";
    el("kpiCards").textContent = fmtInt(cards.size);
    el("kpiAirlines").textContent = fmtInt(airlines.size);
    el("kpiTypes").textContent = fmtInt(types.size);
    el("kpiRegs").textContent = fmtInt(regs.size);
    el("kpiLiveries").textContent = fmtInt(liveries.size);
  }

  function renderRecent(flights){
    const ul = el("recentList");
    ul.innerHTML = "";
    el("recentEmpty").style.display = flights.length ? "none" : "block";

    flights.forEach(f => {
      const d = Number(f.delay||0);
      const code = f.delayCode ? String(f.delayCode).padStart(2,"0") : "";
      const codeTxt = code ? (" â€¢ IATA "+code) : "";
      const liveryTxt = (f.special === true || f.special === "true") ? (" â€¢ ğŸ¨ " + (f.livery || "Sonderlackierung")) : "";
      const paxTxt = (Number(f.pax||0) ? (" â€¢ ğŸ‘¥ "+fmtInt(Number(f.pax||0))) : "");
      const cargoTxt = (Number(f.cargo||0) ? (" â€¢ ğŸ“¦ "+fmtInt(Number(f.cargo||0))+"kg") : "");

      const li = document.createElement("li");
      li.className = "row";
      li.innerHTML = `
        <div class="left">
          <strong>${(f.flightNumber||f.flight||"â€”")} â€¢ ${(f.airline||"â€”")} â€¢ ${(f.aircraft||"â€”")}</strong>
          <span>${(f.registration||"â€”")} â€¢ ${(f.airport||f.from||"")} ${codeTxt}${liveryTxt}${paxTxt}${cargoTxt}</span>
        </div>
        <div class="badge ${delayClass(d)}">${d>0?"+":""}${d} min</div>
      `;
      ul.appendChild(li);
    });
  }

  function renderTopCodes(flights){
    const ul = el("topCodes");
    ul.innerHTML = "";
    const counts = new Map();
    flights.forEach(f => {
      const c = f.delayCode;
      if (!c) return;
      const key = String(c).padStart(2,"0");
      counts.set(key, (counts.get(key)||0) + 1);
    });

    if (counts.size === 0){
      el("codesEmpty").style.display = "block";
      return;
    }
    el("codesEmpty").style.display = "none";

    const top = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 6);
    top.forEach(([code, n]) => {
      const cluster = clusterFromCode(code);
      const li = document.createElement("li");
      li.className = "row";
      li.innerHTML = `
        <div class="left">
          <strong>IATA ${code}</strong>
          <span>${cluster}</span>
        </div>
        <div class="badge">${n}Ã—</div>
      `;
      ul.appendChild(li);
    });
  }

  function renderClusters(flights){
    const box = el("clusterBars");
    box.innerHTML = "";

    const relevant = flights.filter(f => (Number(f.delay||0) !== 0) && f.delayCode);
    const clusters = new Map();
    relevant.forEach(f => {
      const cl = clusterFromCode(f.delayCode);
      clusters.set(cl, (clusters.get(cl)||0) + 1);
    });

    const total = [...clusters.values()].reduce((a,b)=>a+b,0) || 0;
    const order = [
      "Passenger (10â€“19)",
      "Cargo/Ramp (20â€“29)",
      "Handling (30â€“39)",
      "Technical (40â€“49)",
      "Weather/ATC (50â€“59)",
      "Security/Ops (60â€“69)",
      "Crew/Airline (70â€“79)",
      "External (80â€“89)",
      "Misc (90â€“99)",
      "Reserved (00â€“09)",
      "Unknown"
    ];

    if (!total){
      box.innerHTML = `<div class="empty">Noch keine Delay-Codes fÃ¼r eine Cluster-Auswertung.</div>`;
      return;
    }

    order.forEach(name => {
      const n = clusters.get(name) || 0;
      if (!n) return;
      const pct = Math.round((n/total)*100);
      const row = document.createElement("div");
      row.className = "barRow";
      row.innerHTML = `
        <div>${name}</div>
        <div class="bar"><div style="width:${pct}%"></div></div>
        <div style="text-align:right;">${pct}%</div>
      `;
      box.appendChild(row);
    });
  }

  function renderNewCards(flights){
    const ul = el("newCards");
    ul.innerHTML = "";

    const seen = new Set();
    const cards = [];
    for (const f of flights){
      const key = (f.aircraft||"â€”") + " | " + (f.airline||"â€”");
      if (seen.has(key)) continue;
      seen.add(key);
      cards.push({
        aircraft: f.aircraft||"â€”",
        airline: f.airline||"â€”",
        special: (f.special===true || f.special==="true"),
        livery: f.livery||""
      });
      if (cards.length >= 6) break;
    }

    if (!cards.length){
      el("cardsEmpty").style.display = "block";
      return;
    }
    el("cardsEmpty").style.display = "none";

    cards.forEach(c => {
      const li = document.createElement("li");
      li.className = "row";
      li.innerHTML = `
        <div class="left">
          <strong>${c.aircraft} â€¢ ${c.airline}</strong>
          <span>${c.special ? ("ğŸ¨ " + (c.livery || "Sonderlackierung")) : "Standard-Lackierung"}</span>
        </div>
        <div class="badge">ğŸ´</div>
      `;
      ul.appendChild(li);
    });
  }
</script>

</body>
</html>
