<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard â€¢ Ground Handling Log</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container" style="padding-bottom:72px">
  <h2>ğŸ“Š Dashboard</h2>

  <div class="card" id="profile">Ladeâ€¦</div>

  <div class="row">
    <div class="stat"><div class="big" id="kFlights">0</div><div class="label">Abfertigungen</div></div>
    <div class="stat"><div class="big" id="kDelay">0</div><div class="label">Gesamt-Delay</div></div>
    <div class="stat"><div class="big" id="kAvg">0</div><div class="label">Ã˜ Delay</div></div>
    <div class="stat"><div class="big" id="kScore">0â­</div><div class="label">Score</div></div>
  </div>

  <div class="card">
    <button id="logout" class="btn-secondary">Logout</button>
  </div>

  <p class="small" id="dbg"></p>
</div>

<nav>
  <button class="active" data-go="dashboard.html">ğŸ“Š</button>
  <button data-go="flights.html">ğŸ›«</button>
  <button data-go="aircraft.html">âœˆï¸</button>
  <button data-go="album.html">ğŸ´</button>
  <button data-go="social.html">ğŸ‘¥</button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCC9zB_me4qdyBmHZ0TeUDPB1WoPNa6e1A",
  authDomain: "ground-handling-log.firebaseapp.com",
  projectId: "ground-handling-log",
  storageBucket: "ground-handling-log.firebasestorage.app",
  messagingSenderId: "771821879817",
  appId: "1:771821879817:web:35ad14da4ab4613b832ed8",
  measurementId: "G-SS17MF912N"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const dbg = document.getElementById("dbg");

// âœ… WICHTIG: gleiche Persistence wie in index.html
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.log);

async function loadUser(uid){
  const snap = await db.collection("users").doc(uid).get();
  const u = snap.data() || {};
  const s = u.stats || {};

  document.getElementById("profile").innerHTML = `
    <strong>${u.name || "Handler"}</strong><br>
    <span class="small">${u.email || ""}</span>
  `;

  document.getElementById("kFlights").textContent = s.totalFlights || 0;
  document.getElementById("kDelay").textContent = s.totalDelay || 0;
  document.getElementById("kAvg").textContent = (s.avgDelay || 0).toFixed(1);
  document.getElementById("kScore").textContent = `${(s.avgScore || 0).toFixed(1)}â­`;
}

// âœ… Kein harter Redirect bevor Auth entschieden hat
let decided = false;
auth.onAuthStateChanged(async (user) => {
  decided = true;
  if (!user) {
    dbg.textContent = "Nicht eingeloggt â†’ zurÃ¼ck zum Login";
    window.location.replace("index.html");
    return;
  }
  dbg.textContent = "âœ… Eingeloggt";
  await loadUser(user.uid);
});

// Fallback falls iOS â€hÃ¤ngtâ€œ: nach 2.5s prÃ¼fen
setTimeout(() => {
  if (!decided) {
    dbg.textContent = "Auth lÃ¤dt lÃ¤ngerâ€¦";
  }
}, 2500);

document.getElementById("logout").onclick = async () => {
  await auth.signOut();
  window.location.replace("index.html");
};

document.querySelectorAll("nav button").forEach(b=>{
  b.onclick = ()=> location.href = b.dataset.go;
});
</script>

</body>
</html>
